
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Gold Trade Calculator — Split TP & Trailing</title>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;line-height:1.35;margin:24px;color:#111}
    h2{margin:0 0 12px}
    fieldset{border:1px solid #e5e7eb;border-radius:10px;margin:16px 0;padding:12px}
    legend{padding:0 6px;color:#374151}
    label{display:flex;justify-content:space-between;gap:12px;align-items:center;margin:6px 0}
    input,select{padding:6px 8px;border:1px solid #d1d5db;border-radius:8px;min-width:140px}
    .row{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    button{background:#111;color:#fff;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
    button:disabled{opacity:.6;cursor:not-allowed}
    .muted{color:#6b7280;font-size:12px}
    .results{margin-top:16px}
    .card{border:1px solid #e5e7eb;border-radius:12px;padding:12px;margin-top:12px}
    .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace}
    pre{white-space:pre-wrap;word-break:break-word;background:#f9fafb;border:1px solid #e5e7eb;border-radius:8px;padding:10px}
  </style>
</head>
<body>
  <h2>Gold Trade Calculator —10:30 to 15:15 Split TP & Trailing</h2>

  <form id="tradeForm" onsubmit="event.preventDefault();calculateTrade();">
    <fieldset>
      <legend>Market & Account</legend>
      <div class="row">
        <label>Entry Price
          <input type="number" id="entryPrice" step="0.01" required />
        </label>
        <label>ATR
          <input type="number" id="atr" step="0.01" required />
        </label>
        <label>Account Balance
          <input type="number" id="accountBalance" step="0.01" required />
        </label>
        <label>Leverage (e.g. 30 for 30:1)
          <input type="number" id="leverage" step="1" value="20" required />
        </label>
        <label>Trade Direction
          <select id="tradeDirection">
            <option value="long">Long</option>
            <option value="short">Short</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label>Point Value per 1.0 price move
          <input type="number" id="pointValue" step="0.01" value="1" />
        </label>
        <label>Lot Step (round to)
          <input type="number" id="lotStep" step="0.0001" value="0.01" />
        </label>
        <label>Min Lot
          <input type="number" id="minLot" step="0.0001" value="0.01" />
        </label>
      </div>
      <p class="muted">If your broker pays/charges $X per $1 move per 1 lot, set <b>Point Value</b> = X (default 1).</p>
    </fieldset>

    <fieldset>
      <legend>Risk & Bands</legend>
      <div class="row">
        <label>Base Risk % of Equity
          <input type="number" id="riskPct" step="0.01" value="1.00" />
        </label>
        <label>Use Score-Based Scaling
          <select id="useScoreScale">
            <option value="off" selected>Off</option>
            <option value="on">On</option>
          </select>
        </label>
        <label>Forecast Score (abs)
          <input type="number" id="score" step="1" value="8" />
        </label>
      </div>
      <div class="muted">
        Bands (in code): 1–3 → 0.5%, 4–7 → 1.0%, 8–10 → 1.25%, ≥11 → 1.5%.
      </div>
    </fieldset>

    <fieldset>
      <legend>Stop & Targets (ATR multiples)</legend>
      <div class="row">
        <label>Stop Multiplier (SL × ATR) — reference only
          <input type="number" id="slMult" step="0.1" value="1.5" />
        </label>
        <label>TP1 Multiplier (× ATR)
          <input type="number" id="tp1Mult" step="0.1" value="1.1" />
        </label>
        <label>TP2 Multiplier (× ATR)
          <input type="number" id="tp2Mult" step="0.1" value="2.0" />
        </label>
      </div>
    </fieldset>

    <fieldset>
      <legend>Split & Trailing</legend>
      <div class="row">
        <label>TP1 % of Position
          <input type="number" id="tp1Percent" step="1" value="60" />
        </label>
        <label>Trail TP1 (offset × ATR)
          <input type="number" id="trail1Mult" step="0.1" value="1.2" />
        </label>
        <label>Trail TP2 (offset × ATR)
          <input type="number" id="trail2Mult" step="0.1" value="1.2" />
        </label>
      </div>
      <p class="muted">Broker: place two trades by the split. Tick “Trailing” and enter each leg’s SL price shown below.</p>
    </fieldset>

    <div style="display:flex;gap:10px;align-items:center;margin:12px 0">
      <button type="submit">Calculate</button>
      <button type="button" onclick="copyResults()">Copy Results</button>
      <span id="copyStatus" class="muted"></span>
    </div>
  </form>

  <div class="results" id="results"></div>

  <script>
    function roundToStep(x, step, min) {
      if (!isFinite(x)) return 0;
      const rounded = Math.round(x / step) * step;
      return Math.max(min, rounded);
    }
    function riskFromScore(basePct, scoreAbs) {
      if (scoreAbs >= 11) return 1.5;
      if (scoreAbs >= 8)  return 1.25;
      if (scoreAbs >= 4)  return 1.0;
      if (scoreAbs >= 1)  return 0.5;
      return 0.5;
    }
    function fmt(v, d=2){ return isFinite(v) ? v.toFixed(d) : "—"; }

    function calculateTrade() {
      const entryPrice     = parseFloat(document.getElementById('entryPrice').value);
      const atr            = parseFloat(document.getElementById('atr').value);
      const accountBalance = parseFloat(document.getElementById('accountBalance').value);
      const leverage       = parseFloat(document.getElementById('leverage').value);
      const tradeDirection = document.getElementById('tradeDirection').value;

      const pointValue = parseFloat(document.getElementById('pointValue').value || "1");
      const lotStep    = parseFloat(document.getElementById('lotStep').value   || "0.01");
      const minLot     = parseFloat(document.getElementById('minLot').value    || "0.01");

      const slMult   = parseFloat(document.getElementById('slMult').value);
      const tp1Mult  = parseFloat(document.getElementById('tp1Mult').value);
      const tp2Mult  = parseFloat(document.getElementById('tp2Mult').value);

      const tp1Percent = parseFloat(document.getElementById('tp1Percent').value);
      const trail1Mult = parseFloat(document.getElementById('trail1Mult').value);
      const trail2Mult = parseFloat(document.getElementById('trail2Mult').value);

      const baseRiskPct   = parseFloat(document.getElementById('riskPct').value);
      const useScoreScale = document.getElementById('useScoreScale').value === "on";
      const score         = Math.abs(parseFloat(document.getElementById('score').value));

      if ([entryPrice, atr, accountBalance, leverage].some(v => !isFinite(v) || v <= 0)){
        document.getElementById('results').innerHTML = '<p class="bad">Please fill all required inputs with valid numbers > 0.</p>';
        return;
      }
      if (tp1Percent <= 0 || tp1Percent >= 100){
        document.getElementById('results').innerHTML = '<p class="bad">TP1 % must be between 1 and 99.</p>';
        return;
      }

      // Risk % (optionally scaled)
      const riskPct = useScoreScale ? riskFromScore(baseRiskPct, score) : baseRiskPct;
      const riskAmountTotal = accountBalance * (riskPct / 100);

      // Distances (price units)
      const stopDist  = atr * slMult;             // ref only
      const tp1Dist   = atr * tp1Mult;
      const tp2Dist   = atr * tp2Mult;
      const trail1Off = atr * trail1Mult;         // trailing gap L1
      const trail2Off = atr * trail2Mult;         // trailing gap L2

      // Prices
      const isLong = (tradeDirection === 'long');
      const stopPriceRef = isLong ? (entryPrice - stopDist) : (entryPrice + stopDist); // reference
      const tp1Price     = isLong ? (entryPrice + tp1Dist)  : (entryPrice - tp1Dist);
      const tp2Price     = isLong ? (entryPrice + tp2Dist)  : (entryPrice - tp2Dist);

      // SL price (with trailing offset) — this is what you ENTER at the broker with "Trailing" ticked
      const leg1SLprice = isLong ? (entryPrice - trail1Off) : (entryPrice + trail1Off);
      const leg2SLprice = isLong ? (entryPrice - trail2Off) : (entryPrice + trail2Off);

      // --- Size using trailing gaps (matches true broker risk) ---
      const f = tp1Percent / 100; // split fraction
      const riskDistCombined = (f * trail1Off) + ((1 - f) * trail2Off);
      const rawSize = (pointValue > 0 && riskDistCombined > 0)
        ? (riskAmountTotal / (pointValue * riskDistCombined))
        : 0;
      const sizeTotal = roundToStep(rawSize, lotStep, minLot);

      // Split & rounding
      const sizeLeg1 = roundToStep(sizeTotal * f, lotStep, minLot);
      const sizeLeg2 = roundToStep(Math.max(sizeTotal - sizeLeg1, 0), lotStep, minLot);

      // Risk per leg (using each leg’s trailing gap)
      const riskLeg1 = sizeLeg1 * pointValue * trail1Off;
      const riskLeg2 = sizeLeg2 * pointValue * trail2Off;

      // Notional & margin (approx)
      const notional1 = sizeLeg1 * entryPrice;
      const notional2 = sizeLeg2 * entryPrice;
      const margin1   = leverage > 0 ? (notional1 / leverage) : 0;
      const margin2   = leverage > 0 ? (notional2 / leverage) : 0;

      // Copyable broker ticket
      const ticket = [
        `DIR: ${isLong ? 'LONG' : 'SHORT'} | Entry ${fmt(entryPrice,2)} | ATR ${fmt(atr,2)}`,
        `Size total ${fmt(sizeTotal,4)} lots | Risk ${fmt(riskAmountTotal,2)} (${fmt(riskPct,2)}%)`,
        `Leg1 ${fmt(sizeLeg1,4)} lots | TP1 ${fmt(tp1Price,2)} | SL (with trailing offset): ${fmt(leg1SLprice,2)}`,
        `Leg2 ${fmt(sizeLeg2,4)} lots | TP2 ${fmt(tp2Price,2)} | SL (with trailing offset): ${fmt(leg2SLprice,2)}`,
        `(Ref) Static SL×ATR: ${fmt(stopPriceRef,2)}`
      ].join('\n');

      // Render
      const html = `
        <div class="card">
          <h3>Summary</h3>
          <div class="row">
            <div>
              <p>Direction: <b>${isLong ? 'LONG' : 'SHORT'}</b></p>
              <p>ATR: <b>${fmt(atr,2)}</b></p>
              <p>Total Risk: <b>${fmt(riskAmountTotal,2)}</b> (${fmt(riskPct,2)}%)</p>
              <p>Total Size: <b class="mono">${fmt(sizeTotal,4)}</b> lots</p>
            </div>
            <div>
              <p><b>Leg 1 — SL price (with trailing offset):</b> <span class="mono">${fmt(leg1SLprice,2)}</span></p>
              <p><b>Leg 2 — SL price (with trailing offset):</b> <span class="mono">${fmt(leg2SLprice,2)}</span></p>
              <p class="muted">(Ref) Static SL×ATR: <span class="mono">${fmt(stopPriceRef,2)}</span></p>
              <p>TP1: <b class="mono">${fmt(tp1Price,2)}</b> &nbsp;|&nbsp; TP2: <b class="mono">${fmt(tp2Price,2)}</b></p>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Leg 1 (TP1 ${fmt(tp1Percent,0)}%)</h3>
          <div class="row">
            <div>
              <p>Size: <b class="mono">${fmt(sizeLeg1,4)}</b> lots</p>
              <p>Risk (approx): <b>${fmt(riskLeg1,2)}</b></p>
              <p>Notional: <b>${fmt(notional1,2)}</b></p>
              <p>Margin @ ${fmt(leverage,0)}×: <b>${fmt(margin1,2)}</b></p>
            </div>
            <div>
              <p>TP1 Price: <b class="mono">${fmt(tp1Price,2)}</b></p>
              <p><b>SL price (with trailing offset):</b> <span class="mono">${fmt(leg1SLprice,2)}</span></p>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Leg 2 (TP2 ${fmt(100 - tp1Percent,0)}%)</h3>
          <div class="row">
            <div>
              <p>Size: <b class="mono">${fmt(sizeLeg2,4)}</b> lots</p>
              <p>Risk (approx): <b>${fmt(riskLeg2,2)}</b></p>
              <p>Notional: <b>${fmt(notional2,2)}</b></p>
              <p>Margin @ ${fmt(leverage,0)}×: <b>${fmt(margin2,2)}</b></p>
            </div>
            <div>
              <p>TP2 Price: <b class="mono">${fmt(tp2Price,2)}</b></p>
              <p><b>SL price (with trailing offset):</b> <span class="mono">${fmt(leg2SLprice,2)}</span></p>
            </div>
          </div>
        </div>

        <div class="card">
          <h3>Broker Ticket (copy/paste)</h3>
          <pre class="mono">${ticket}</pre>
          <p class="muted">Most platforms trail from the distance defined by this initial SL price. If your platform trails only after the trade is in profit, these prices still serve as your protective stops.</p>
        </div>
      `;
      document.getElementById('results').innerHTML = html;
    }

    function copyResults(){
      const el = document.getElementById('results');
      if(!el || !el.innerText){return;}
      navigator.clipboard.writeText(el.innerText)
        .then(()=>{document.getElementById('copyStatus').textContent="Copied!"; setTimeout(()=>{document.getElementById('copyStatus').textContent="";},1500);})
        .catch(()=>{document.getElementById('copyStatus').textContent="Copy failed";});
    }
  </script>
</body>
</html>




